# Docker Compose Override — Production Configuration
# Generated by create-openclaw-agent. Customize as needed.
# Secrets are injected via .env from Secret Manager (tmpfs, never on disk).
#
# Security hardening:
#   - Bridge network (no host network) — containers isolated, gateway ports bound to 127.0.0.1
#   - Read-only root filesystem + tmpfs for writable paths
#   - All Linux capabilities dropped (chrome gets SYS_ADMIN for --no-sandbox)
#   - Images pinned by version + SHA256 digest

networks:
  openclaw-net:
    driver: bridge

services:
  openclaw-gateway:
    depends_on:
      qdrant:
        condition: service_started
      chrome:
        condition: service_started
    networks: [openclaw-net]
    ports:
      - "127.0.0.1:18789:18789"
      - "127.0.0.1:18790:18790"
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
      TZ: ${TZ:-UTC}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    read_only: true
    tmpfs:
      - /tmp:size=100M
      - /home/node/.cache:size=50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:18789/health', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1536M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.13.2@sha256:81bdf0a9deedbeec68eed207145ade0b9d5db15e2f84069180711aa9698445b1
    networks: [openclaw-net]
    volumes:
      - ${OPENCLAW_CONFIG_DIR}/memory/qdrant:/qdrant/storage
    read_only: true
    tmpfs:
      - /tmp:size=50M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/healthz"]
      interval: 60s
      timeout: 5s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    restart: unless-stopped

  chrome:
    image: chromedp/headless-shell:145.0.7632.46@sha256:478f1105d06e921d7652c18ecf6d1fc81d9bf3c484ef39562b8e7760d42d71a8
    networks: [openclaw-net]
    entrypoint:
      - /headless-shell/headless-shell
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --user-data-dir=/data/chrome
      - about:blank
    volumes:
      - ${OPENCLAW_CONFIG_DIR}/browser/chrome-data:/data/chrome
    read_only: true
    tmpfs:
      - /tmp:size=100M
      - /dev/shm:size=256M
    healthcheck:
      # 0x2406 = 9222 in hex; /proc/net/tcp uses hex port numbers
      test: ["CMD-SHELL", "grep -q ':2406 ' /proc/net/tcp 2>/dev/null || grep -q ':2406 ' /proc/net/tcp6 2>/dev/null"]
      interval: 60s
      timeout: 5s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop: [ALL]
    cap_add: [SYS_ADMIN]
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 1024M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    restart: unless-stopped
