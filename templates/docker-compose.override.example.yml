# Docker Compose Override â€” Production Configuration
# Generated by create-openclaw-agent. Customize as needed.
# Secrets are injected via .env from Secret Manager (tmpfs, never on disk).
services:
  openclaw-gateway:
    network_mode: host
    depends_on:
      qdrant:
        condition: service_started
      chrome:
        condition: service_started
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
      TZ: ${TZ:-UTC}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:18789/health', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1536M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.13.2
    network_mode: host
    volumes:
      - ${OPENCLAW_CONFIG_DIR}/memory/qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/healthz"]
      interval: 60s
      timeout: 5s
      retries: 3
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    restart: unless-stopped

  chrome:
    image: chromedp/headless-shell:latest
    network_mode: host
    entrypoint:
      - /headless-shell/headless-shell
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=127.0.0.1
      - --remote-debugging-port=9222
      - --user-data-dir=/data/chrome
      - about:blank
    volumes:
      - ${OPENCLAW_CONFIG_DIR}/browser/chrome-data:/data/chrome
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/127.0.0.1/9222"]
      interval: 60s
      timeout: 5s
      retries: 3
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 1024M
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    restart: unless-stopped
