name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  shellcheck:
    name: Shell Script Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck
      - name: Lint shell scripts
        run: |
          shellcheck -x lib/*.sh
          shellcheck -x scripts/run-e2e.sh
          shellcheck -x providers/gcp/provider.sh
          shellcheck -x providers/gcp/scripts/restore.sh
          shellcheck -x setup.sh
          shellcheck -x install.sh

  terraform:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@9d84900f3238fab8cd84ce47d658d25dd008be2f # v1.0.8
      - name: Validate GCP provider
        working-directory: providers/gcp/infra
        run: |
          tofu init -backend=false
          tofu validate
          tofu fmt -check

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Install yamllint
        run: pip install yamllint
      - name: Lint YAML templates
        run: |
          yamllint -d relaxed templates/agent-config.example.yml
          yamllint -d relaxed templates/docker-compose.override.example.yml

  secrets-check:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  image-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Scan Qdrant image
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: 'qdrant/qdrant:v1.13.2'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      - name: Scan Chrome image
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: 'chromedp/headless-shell:stable'
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
